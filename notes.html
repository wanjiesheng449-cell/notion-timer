<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é—ªå¿µèƒ¶å›Š AI Pro (æ¨±èŠ±ç²‰)</title>
    <style>
        /* --- åŸºç¡€é£æ ¼ (ç²‰è‰²ç³») --- */
        body {
            background-color: #fff0f3;
            color: #5c3a41;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            height: 100vh;
            box-sizing: border-box;
        }

        /* --- é¡¶éƒ¨å¯¼èˆªæ  --- */
        .header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px dashed #ffccd5;
        }
        .app-title {
            font-size: 18px;
            font-weight: bold;
            color: #ff7597;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .header-right {
            display: flex;
            gap: 10px;
        }
        .btn-nav {
            background: #fff;
            border: 1px solid #ffb3c1;
            color: #ff7597;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(255, 182, 193, 0.2);
        }
        .btn-nav:hover { background: #ff7597; color: #fff; border-color: #ff7597; }

        /* --- è§†å›¾å®¹å™¨ --- */
        .view-container {
            flex: 1;
            overflow-y: auto;
            display: none;
        }
        .view-container.active { display: block; }

        /* --- è¾“å…¥åŒº --- */
        .input-box {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .input-main {
            flex: 1;
            padding: 12px 15px;
            border-radius: 12px;
            border: 2px solid #ffe3e8;
            background: #fff;
            color: #5c3a41;
            font-size: 16px;
            outline: none;
            transition: all 0.2s;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.02);
        }
        .input-main:focus { border-color: #ff8fa3; background: #fff; }
        .input-main::placeholder { color: #dcb0ba; }
        
        button.btn-add {
            background: #ff7597;
            color: white;
            border: none;
            padding: 0 20px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(255, 117, 151, 0.3);
            transition: transform 0.1s;
        }
        button.btn-add:hover { background: #ff5c86; transform: translateY(-1px); }
        button.btn-add:active { transform: translateY(1px); }

        /* --- åˆ—è¡¨å¡ç‰‡ --- */
        .card {
            background: #ffffff;
            border: 1px solid #ffe3e8;
            margin-bottom: 12px;
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(255, 182, 193, 0.15);
        }
        .card:hover { 
            border-color: #ffb3c1; 
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 182, 193, 0.25);
        }
        
        .card-head {
            padding: 10px 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            min-height: 40px;
        }

        .head-left {
            display: flex;
            align-items: center;
            flex: 1;
            gap: 10px;
            overflow: hidden;
        }
        
        .arrow-btn {
            cursor: pointer;
            color: #ffb3c1;
            font-size: 12px;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s;
            background: #fff0f3;
            flex-shrink: 0;
        }
        .arrow-btn:hover { color: #ff7597; background: #ffe6eb; }
        .card.open .arrow-btn { transform: rotate(90deg); background: #ff7597; color: #fff; }

        input.title-edit {
            background: transparent;
            border: none;
            color: #5c3a41;
            font-size: 15px;
            font-weight: 600;
            width: 100%;
            outline: none;
            font-family: inherit;
        }
        input.title-edit:focus { color: #ff5c86; }
        .archived-title { text-decoration: line-through; color: #dcb0ba !important; }

        .head-right {
            display: flex;
            gap: 6px;
            margin-left: 10px;
            opacity: 0; 
            transition: opacity 0.2s;
        }
        .card:hover .head-right { opacity: 1; }

        .btn-icon {
            padding: 5px 10px;
            font-size: 12px;
            background: #fff0f3;
            border: 1px solid transparent;
            color: #ff8fa3;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }
        .btn-icon:hover { background: #ffe6eb; color: #ff5c86; }
        .btn-del:hover { background: #fff5f5; color: #ff4d4d; border-color: #ffcccc; }

        /* è¯¦æƒ…åŒº */
        .card-body {
            display: none;
            border-top: 1px dashed #ffe3e8;
            background: #fffafa;
            position: relative;
        }
        .card.open .card-body { display: block; }

        /* AI å·¥å…·æ  */
        .ai-toolbar {
            padding: 8px 15px;
            background: #fff0f3;
            border-bottom: 1px dashed #ffe3e8;
            display: flex;
            gap: 8px;
            flex-wrap: wrap; /* é˜²æ­¢æŒ‰é’®è¿‡å¤šæ¢è¡Œ */
        }
        
        .btn-ai {
            background: white;
            border: 1px solid #ffb3c1;
            color: #ff7597;
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.2s;
        }
        .btn-ai:hover { background: #ff7597; color: white; }
        .btn-ai.loading { opacity: 0.7; cursor: wait; }

        textarea.body-edit {
            width: 100%;
            min-height: 120px;
            background: transparent;
            border: none;
            color: #7d5a60;
            resize: vertical;
            outline: none;
            padding: 15px;
            font-family: inherit;
            font-size: 14px;
            line-height: 1.6;
            box-sizing: border-box;
            display: block;
        }
        textarea.body-edit::placeholder { color: #e0c0c8; }

        /* æ¨¡æ€æ¡† (è®¾ç½® API Key) */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(92, 58, 65, 0.3);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal {
            background: white;
            padding: 25px;
            border-radius: 16px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .modal h3 { margin: 0 0 15px 0; color: #ff7597; }
        .modal input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ffe3e8;
            border-radius: 8px;
            margin-bottom: 15px;
            box-sizing: border-box;
            outline: none;
        }
        .modal input:focus { border-color: #ff7597; }
        .modal-buttons { display: flex; justify-content: flex-end; gap: 10px; }
        
        /* ç©ºçŠ¶æ€ */
        .empty-tip {
            text-align: center;
            color: #dcb0ba;
            margin-top: 60px;
            font-size: 14px;
            font-weight: bold;
        }
    </style>
</head>
<body>

    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <div class="header-bar">
        <div class="app-title" id="pageTitle">ğŸŒ¸ é—ªå¿µèƒ¶å›Š AI</div>
        <div class="header-right">
            <button class="btn-nav" onclick="openSettings()">âš™ï¸ è®¾ç½®</button>
            <button class="btn-nav" id="navBtn" onclick="switchView()">ğŸ€ å½’æ¡£ç®±</button>
        </div>
    </div>

    <!-- è§†å›¾1ï¼šè¿›è¡Œä¸­ -->
    <div id="view-active" class="view-container active">
        <div class="input-box">
            <input type="text" class="input-main" id="newTitle" placeholder="å†™ä¸‹ä½ çš„å°æƒ³æ³•..." onkeypress="if(event.keyCode==13) addNote()">
            <button class="btn-add" onclick="addNote()">è®°å½•</button>
        </div>
        <div id="list-active"></div>
    </div>

    <!-- è§†å›¾2ï¼šå·²å½’æ¡£ -->
    <div id="view-archive" class="view-container">
        <div id="list-archive"></div>
    </div>

    <!-- è®¾ç½® API Key æ¨¡æ€æ¡† -->
    <div class="modal-overlay" id="settingsModal">
        <div class="modal">
            <h3>âš™ï¸ è®¾ç½® Gemini API Key</h3>
            <p style="font-size:12px; color:#888; margin-bottom:10px;">
                ä¸ºäº†ä½¿ç”¨ AI åŠŸèƒ½ï¼Œè¯·è¾“å…¥æ‚¨çš„ Google Gemini API Keyã€‚<br>
                (Key ä»…ä¿å­˜åœ¨æ‚¨çš„æµè§ˆå™¨æœ¬åœ°ï¼Œä¸ä¼šä¸Šä¼ )
            </p>
            <input type="password" id="apiKeyInput" placeholder="åœ¨æ­¤ç²˜è´´ API Key">
            <div class="modal-buttons">
                <button class="btn-nav" onclick="closeSettings()">å–æ¶ˆ</button>
                <button class="btn-add" onclick="saveApiKey()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <script>
        // --- æ ¸å¿ƒé…ç½® ---
        const systemApiKey = ""; 

        // --- æ•°æ®é€»è¾‘ ---
        let notes = [];
        let currentView = 'active';

        try {
            const saved = localStorage.getItem('notes_v4_clean'); 
            if (saved) notes = JSON.parse(saved);
        } catch (e) { console.error("Storage Error"); }

        function save() { try { localStorage.setItem('notes_v4_clean', JSON.stringify(notes)); } catch (e) {} }
        function saveAndRender() { save(); render(); }

        // --- API Key ç®¡ç† ---
        function getApiKey() {
            return localStorage.getItem('user_gemini_api_key') || systemApiKey;
        }
        function openSettings() {
            document.getElementById('settingsModal').style.display = 'flex';
            document.getElementById('apiKeyInput').value = localStorage.getItem('user_gemini_api_key') || '';
        }
        function closeSettings() {
            document.getElementById('settingsModal').style.display = 'none';
        }
        function saveApiKey() {
            const key = document.getElementById('apiKeyInput').value.trim();
            localStorage.setItem('user_gemini_api_key', key);
            closeSettings();
            alert("API Key å·²ä¿å­˜ï¼âœ¨");
        }

        // --- AI è°ƒç”¨é€»è¾‘ ---
        async function callGemini(noteId, type) {
            const apiKey = getApiKey();
            if (!apiKey) {
                alert("è¯·å…ˆç‚¹å‡»å³ä¸Šè§’ã€è®¾ç½®ã€‘å¡«å…¥ Gemini API Key ğŸŒ¸");
                openSettings();
                return;
            }

            const note = notes.find(n => n.id === noteId);
            if (!note) return;

            const btnId = `ai-btn-${type}-${noteId}`;
            const btn = document.getElementById(btnId);
            const originalText = btn.innerHTML;
            
            // Loading çŠ¶æ€
            btn.innerHTML = 'âœ¨ æ€è€ƒä¸­...';
            btn.classList.add('loading');
            
            let prompt = "";
            const content = note.title + (note.body ? "\nDetails: " + note.body : "");

            if (type === 'expand') {
                prompt = `ä½ æ˜¯ä¸€ä¸ªæœ‰å¸®åŠ©çš„åŠ©æ‰‹ã€‚è¯·æ ¹æ®ä»¥ä¸‹ç¬”è®°å†…å®¹ï¼Œæ‰©å†™æˆè¯¦ç»†çš„æ­¥éª¤ã€æ³¨æ„äº‹é¡¹æˆ–è‰ç¨¿ã€‚ä¿æŒè¯­æ°”å‹å¥½ç®€æ´ã€‚ç¬”è®°å†…å®¹ï¼š "${content}"`;
            } else if (type === 'todo') {
                prompt = `è¯·å°†ä»¥ä¸‹ç¬”è®°å†…å®¹æ‹†è§£ä¸ºä¸€æ­¥æ­¥çš„å¾…åŠæ¸…å•ã€‚ä½¿ç”¨ç®€å•çš„çŸ­æ¨ªçº¿ - ä½œä¸ºåˆ—è¡¨ç¬¦å·ã€‚ç¬”è®°å†…å®¹ï¼š "${content}"`;
            } else if (type === 'polish') {
                prompt = `è¯·æ¶¦è‰²ä»¥ä¸‹æ–‡æœ¬ï¼Œä½¿å…¶æ›´é€šé¡ºã€æ¸…æ™°ã€ç»“æ„æ›´å¥½ï¼ŒåŒæ—¶ä¿æŒåŸæœ‰è¯­æ°”ã€‚ç›´æ¥è¾“å‡ºæ¶¦è‰²åçš„å†…å®¹ã€‚å†…å®¹ï¼š "${content}"`;
            } else if (type === 'emojify') {
                prompt = `è¯·é‡å†™ä»¥ä¸‹æ–‡æœ¬ï¼ŒåŠ å…¥é€‚é‡å¯çˆ±ä¸”ç›¸å…³çš„ Emoji è¡¨æƒ…ç¬¦å·ï¼Œä½¿å…¶çœ‹èµ·æ¥æ›´æ´»æ³¼æœ‰è¶£ï¼ˆç¬¦åˆæ¨±èŠ±ç²‰è‰²ç³»é£æ ¼ï¼‰ã€‚å†…å®¹ï¼š "${content}"`;
            }

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }]
                    })
                });

                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error.message);
                }

                const resultText = data.candidates[0].content.parts[0].text;
                
                // è‡ªåŠ¨è¿½åŠ å†…å®¹
                const separator = note.body ? "\n\n--- AI ç”Ÿæˆ ---\n" : "";
                note.body = (note.body || "") + separator + resultText;
                
                saveAndRender();
                
                // ç¡®ä¿å±•å¼€å¹¶æ»šåŠ¨åˆ°åº•éƒ¨
                setTimeout(() => {
                   const card = document.getElementById(`card-${noteId}`);
                   if(card && !note.isOpen) toggleOpen(noteId); 
                }, 100);

            } catch (error) {
                alert("AI è°ƒç”¨å¤±è´¥: " + error.message);
            } finally {
                btn.innerHTML = originalText;
                btn.classList.remove('loading');
            }
        }

        // --- è§†å›¾åˆ‡æ¢ä¸å¸¸è§„é€»è¾‘ ---
        function switchView() {
            const activeEl = document.getElementById('view-active');
            const archiveEl = document.getElementById('view-archive');
            const btn = document.getElementById('navBtn');
            const title = document.getElementById('pageTitle');

            if (currentView === 'active') {
                currentView = 'archive';
                activeEl.classList.remove('active');
                archiveEl.classList.add('active');
                btn.innerHTML = 'â¬…ï¸ è¿”å›';
                title.innerText = 'ğŸ€ å†å²è®°å½•';
            } else {
                currentView = 'active';
                archiveEl.classList.remove('active');
                activeEl.classList.add('active');
                btn.innerHTML = 'ğŸ€ å½’æ¡£ç®±';
                title.innerText = 'ğŸŒ¸ é—ªå¿µèƒ¶å›Š AI';
            }
            render();
        }

        function addNote() {
            const input = document.getElementById('newTitle');
            const val = input.value.trim();
            if (!val) return;
            notes.unshift({ id: Date.now(), title: val, body: "", isArchived: false, isOpen: false });
            input.value = '';
            saveAndRender();
        }

        function deleteNote(id) {
            notes = notes.filter(n => n.id !== id);
            saveAndRender();
        }

        function toggleArchive(id) {
            const n = notes.find(x => x.id === id);
            if (n) {
                n.isArchived = !n.isArchived;
                n.isOpen = false;
                saveAndRender();
            }
        }

        function toggleOpen(id) {
            const n = notes.find(x => x.id === id);
            if (n) { n.isOpen = !n.isOpen; saveAndRender(); }
        }

        function updateTitle(id, newTitle) {
            const n = notes.find(x => x.id === id);
            if (n) { n.title = newTitle; save(); }
        }

        function updateBody(id, newBody) {
            const n = notes.find(x => x.id === id);
            if (n) { n.body = newBody; save(); }
        }

        function render() {
            const container = currentView === 'active' ? document.getElementById('list-active') : document.getElementById('list-archive');
            container.innerHTML = '';
            const filteredNotes = notes.filter(n => currentView === 'active' ? !n.isArchived : n.isArchived);

            if (filteredNotes.length === 0) {
                container.innerHTML = `<div class="empty-tip">${currentView === 'active' ? 'âœ¨ ä»Šå¤©æœ‰ä»€ä¹ˆå¥‡æ€å¦™æƒ³ï¼Ÿ' : 'è¿™é‡Œç©ºç©ºå¦‚ä¹Ÿ~'}</div>`;
                return;
            }

            filteredNotes.forEach(n => {
                const openClass = n.isOpen ? 'open' : '';
                const titleClass = n.isArchived ? 'title-edit archived-title' : 'title-edit';
                const archiveBtnText = n.isArchived ? 'è¿˜åŸ' : 'å½’æ¡£';

                const html = `
                    <div class="card ${openClass}" id="card-${n.id}">
                        <div class="card-head">
                            <div class="head-left">
                                <div class="arrow-btn" onclick="toggleOpen(${n.id})">â–¶</div>
                                <input class="${titleClass}" value="${n.title}" oninput="updateTitle(${n.id}, this.value)" placeholder="æ— æ ‡é¢˜">
                            </div>
                            <div class="head-right">
                                <button class="btn-icon" onclick="toggleArchive(${n.id})">${archiveBtnText}</button>
                                <button class="btn-icon btn-del" onclick="deleteNote(${n.id})">åˆ é™¤</button>
                            </div>
                        </div>
                        <div class="card-body">
                            <!-- AI å·¥å…·æ  (ä»…åœ¨æœªå½’æ¡£çŠ¶æ€æ˜¾ç¤º) -->
                            ${!n.isArchived ? `
                            <div class="ai-toolbar">
                                <button class="btn-ai" id="ai-btn-expand-${n.id}" onclick="callGemini(${n.id}, 'expand')">âœ¨ æ‰©å†™</button>
                                <button class="btn-ai" id="ai-btn-todo-${n.id}" onclick="callGemini(${n.id}, 'todo')">ğŸ“‹ å¾…åŠ</button>
                                <button class="btn-ai" id="ai-btn-polish-${n.id}" onclick="callGemini(${n.id}, 'polish')">âœï¸ æ¶¦è‰²</button>
                                <button class="btn-ai" id="ai-btn-emojify-${n.id}" onclick="callGemini(${n.id}, 'emojify')">ğŸŒ¸ èŒåŒ–</button>
                            </div>
                            ` : ''}
                            <textarea class="body-edit" placeholder="è®°ä¸‹è¯¦ç»†çš„å°ç§˜å¯†..." oninput="updateBody(${n.id}, this.value)">${n.body}</textarea>
                        </div>
                    </div>
                `;
                container.innerHTML += html;
            });
        }
        render();
    </script>
</body>
</html>
